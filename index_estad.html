<!DOCTYPE html><html lang="es"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="manifest" href="./manifest.json">
<link rel="icon" type="image/png" href="./img/logo.png">
<link rel="apple-touch-icon" href="./img/logo.png">

<title>CV Stats - Protected Offline</title>
<script src="./libs/tailwind.js"></script>
<script src="./libs/charts.js"></script>

<style>:root{--b:#0056FF}body{font-family:Inter,sans-serif;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;background:#F7F8FA}.card{background:#fff;border:1px solid #d1d5db;box-shadow:0 4px 10px -1px rgba(0,86,255,.1)}.toast{position:fixed;bottom:2rem;left:50%;transform:translateX(-50%);background:#1f2937;color:#fff;padding:.75rem 1.5rem;border-radius:.5rem;opacity:0;transition:opacity .3s;pointer-events:none;z-index:9999}.v{opacity:1}input::-webkit-inner-spin-button,input::-webkit-outer-spin-button{-webkit-appearance:none;margin:0}
.hidden { display: none; }</style></head>
<body class="p-4 text-gray-800" oncontextmenu="return false">

    <div id="installArea" class="hidden fixed top-4 left-1/2 -translate-x-1/2 z-[1000] w-full max-w-xs px-4">
        <button id="btnInstall" class="w-full bg-yellow-500 text-black font-bold py-3 rounded-full shadow-2xl border-2 border-white animate-bounce">
             INSTALAR APLICACIN
        </button>
    </div>

    <main class="max-w-5xl mx-auto space-y-6">
        <header class="text-center relative">
            <button onclick="window.close()" class="absolute top-0 right-0 bg-red-600 text-white px-4 py-1 rounded-md text-sm font-bold shadow-md hover:bg-red-700 transition">Salir</button>
            <h1 class="text-3xl font-black">Control Voley <span class="text-yellow-600">Stats</span></h1>
            <p class="text-[10px] text-gray-400">Offline Protected Mode</p>
        </header>
        <div class="grid gap-6">
            <div class="card p-4 rounded-lg"><h2 class="text-xl font-bold mb-3 border-b border-[#0056FF]">Atleta</h2><div class="flex gap-2"><input id="pN" placeholder="Nro" class="w-20 border p-2 rounded" type="number"><input id="pM" placeholder="Nombre" class="flex-grow border p-2 rounded" type="text"><button id="add" class="bg-[#0056FF] text-white px-4 rounded">Agregar</button></div></div>
            <div class="card p-4 rounded-lg"><h2 class="text-xl font-bold mb-3 border-b border-[#0056FF]">Acci贸n</h2><form id="f"><select id="ps" class="w-full border p-2 mb-2 rounded"></select><select id="as" class="w-full border p-2 mb-3 rounded"></select><button class="w-full bg-[#0056FF] text-white py-2 rounded font-bold mb-2">Registrar</button><div class="grid grid-cols-2 gap-2"><button type="button" id="rs" class="bg-amber-600 text-white py-1 rounded text-sm">Limpiar Set</button><button type="button" id="ra" class="bg-red-600 text-white py-1 rounded text-sm">Limpiar Todo</button></div></form></div>
            <div class="card p-4 rounded-lg"><h2 class="text-xl font-bold mb-3 border-b border-[#0056FF]">Estad铆stica</h2><div id="st" class="space-y-2"></div></div>
            <div class="card p-4 rounded-lg h-64"><canvas id="c1"></canvas></div>
            <div class="card p-4 rounded-lg h-80"><canvas id="c2"></canvas><div id="sum" class="text-center mt-2 text-xs font-bold"></div></div>
        </div>
    </main>

<script>
(function(){
    const _0x1=[window,'keydown','keyCode','ctrlKey','shiftKey','preventDefault','DOMContentLoaded','vP','vM','vS','st','c1','c2','sum','ps','as','add','pN','pM','f','rs','ra'];
    document.addEventListener('keydown',function(e){if(e[_0x1[2]]==123||(e[_0x1[3]]&&e[_0x1[4]]&&(e[_0x1[2]]==73||e[_0x1[2]]==74))||(e[_0x1[3]]&&e[_0x1[2]]==85)){e[_0x1[5]]();return false}});
    
    let _vP=[],_vM=[],_vS=[],_b1=null,_b2=null;
    const g=id=>document.getElementById(id);
    
    const _0xa={'\x53\x65\x72\x76\x69\x63\x69\x6f\x20\x42\x75\x65\x6e\x6f\x20\x53\x23':1,'\x41\x74\x61\x71\x75\x65\x20\x42\x75\x65\x6e\x6f\x20\x41\x23':1,'\x42\x6c\x6f\x71\x75\x65\x6f\x20\x42\x75\x65\x6e\x6f\x20\x42\x23':1,'\x43\x6f\x6c\x6f\x71\x75\x65\x20\x42\x75\x65\x6e\x6f\x20\x43\x23':1,'\x53\x65\x72\x76\x69\x63\x69\x6f\x20\x4d\x61\x6c\x6f\x20\x53\x3d':-1,'\x41\x74\x61\x71\x75\x65\x20\x4d\x61\x6c\x6f\x20\x41\x3d':-1,'\x42\x6c\x6f\x71\x75\x65\x6f\x20\x4d\x61\x6c\x6f\x20\x42\x3d':-1,'\x52\x65\x63\x65\x70\x63\x69\x6f\x6e\x20\x4d\x61\x6c\x6f\x20\x52\x3d':-1,'\x43\x6f\x6c\x6f\x71\x75\x65\x20\x4d\x61\x6c\x6f\x20\x43\x3d':-1,'\x44\x65\x66\x65\x6e\x73\x61\x20\x4d\x61\x6c\x6f\x20\x44\x3d':-1};
    const _0xo={S:'\x53\x65\x72\x76\x69\x63\x69\x6f',A:'\x41\x74\x61\x71\x75\x65',B:'\x42\x6c\x6f\x71\x75\x65\x6f',R:'\x52\x65\x63\x65\x70\x63\x69\x6f\x6e',C:'\x43\x6f\x6c\x6f\x71\x75\x65',D:'\x44\x65\x66\x65\x6e\x73\x61'};
    const P={b:'#0056FF',r:'#dc2626',o:'#f97316',g:'#10b981'},K={scales:{y:{ticks:{stepSize:1}}},responsive:1,maintainAspectRatio:0};

    function _t(m){const t=document.createElement('div');t.className='toast';t.textContent=m;document.body.appendChild(t);setTimeout(()=>t.classList.add('v'),10);setTimeout(()=>{t.classList.remove('v');setTimeout(()=>t.remove(),300)},3000)}
    function _s(){localStorage.setItem(_0x1[7],JSON.stringify(_vP));localStorage.setItem(_0x1[8],JSON.stringify(_vM));localStorage.setItem(_0x1[9],JSON.stringify(_vS))}
    
    function _u(){
        const s=g(_0x1[10]);s.innerHTML='';if(!_vP.length){s.innerHTML='<p class="text-center">Vac铆o</p>';return}
        let d={};_vP.forEach(p=>d[p.number]={p:0,n:0,a:{}});
        _vS.forEach(l=>{let k=d[l.playerNumber];if(k){let v=_0xa[l.action],t=l.action.charAt(l.action.length-2);v>0?k.p++:k.n++;if(!k.a[t])k.a[t]={p:0,n:0};v>0?k.a[t].p++:k.a[t].n++}});
        _vP.forEach(p=>{let k=d[p.number],dt='';Object.keys(k.a).forEach(x=>dt+=`<span class="mr-2">${x}:${k.a[x].p}|${k.a[x].n}</span>`);s.innerHTML+=`<div class="bg-gray-100 p-2 rounded text-xs"><div class="flex justify-between font-bold"><span>#${p.number} ${p.name}</span><span>Dif: ${k.p-k.n}</span></div><div class="text-[9px] text-gray-500">${dt}</div></div>`});
        if(typeof Chart === 'undefined') return;
        const x1=g(_0x1[11]).getContext('2d'),x2=g(_0x1[12]).getContext('2d'),l=Object.values(_0xo);
        let v1={p:[],n:[]},v2={p:[],n:[]},tp=0,tn=0;
        Object.keys(_0xo).forEach(k=>{let p=0,n=0,ap=0,an=0;_vS.forEach(z=>{if(z.action.charAt(z.action.length-2)===k)_0xa[z.action]>0?p++:n++});_vM.forEach(z=>{if(z.action.charAt(z.action.length-2)===k){if(_0xa[z.action]>0){ap++;tp++}else{an++;tn++}}});v1.p.push(p);v1.n.push(n);v2.p.push(ap);v2.n.push(an)});
        if(_b1)_b1.destroy();_b1=new Chart(x1,{type:'bar',data:{labels:l,datasets:[{label:'+',data:v1.p,backgroundColor:P.b},{label:'-',data:v1.n,backgroundColor:P.o}]},options:{...K,plugins:{title:{display:1,text:'SET ACTUAL'}}}});
        g(_0x1[13]).innerHTML=`Pos: ${tp} | Neg: ${tn}`;
        if(_b2)_b2.destroy();_b2=new Chart(x2,{type:'bar',data:{labels:l,datasets:[{label:'+',data:v2.p,backgroundColor:P.g},{label:'-',data:v2.n,backgroundColor:P.o}]},options:{...K,plugins:{title:{display:1,text:'TOTAL PARTIDO'}}}})}

    document.addEventListener(_0x1[6],()=>{
        _vP=JSON.parse(localStorage.getItem(_0x1[7])||'[]');
        _vM=JSON.parse(localStorage.getItem(_0x1[8])||'[]');
        _vS=JSON.parse(localStorage.getItem(_0x1[9])||'[]');
        const ps=g(_0x1[14]),as=g(_0x1[15]);
        function rP(){ps.innerHTML='';_vP.sort((a,b)=>a.number-b.number).forEach(p=>{let o=document.createElement('option');o.value=p.number;o.textContent=`#${p.number} ${p.name}`;ps.appendChild(o)})}
        Object.keys(_0xa).forEach(k=>{let o=document.createElement('option');o.value=k;o.textContent=k;as.appendChild(o)});
        g(_0x1[16]).onclick=()=>{let n=parseInt(g(_0x1[17]).value),m=g(_0x1[18]).value;if(n&&m){_vP.push({number:n,name:m});_s();rP();_u();g(_0x1[17]).value='';g(_0x1[18]).value='';_t('OK')}};
        g(_0x1[19]).onsubmit=e=>{e.preventDefault();if(ps.value){let l={playerNumber:parseInt(ps.value),action:as.value};_vM.push(l);_vS.push(l);_s();_u();_t('Reg')}};
        g(_0x1[20]).onclick=()=>{if(confirm('驴Limpiar Set?')){_vS=[];_s();_u()}};
        
        // L贸gica de Limpiar Todo con mensaje y cierre autom谩tico
        g(_0x1[21]).onclick=()=>{
            if(confirm('驴Limpiar TODO?')){
                localStorage.clear();
                _t('Datos de juego borrados, por favor vuelve a entrar a la Aplicaci贸n');
                setTimeout(() => {
                    window.close();
                    setTimeout(() => { location.href = "about:blank"; }, 500);
                }, 3000);
            }
        };
        rP();_u();
    })
})();

// L贸gica de instalaci贸n PWA
let deferredPrompt;
const installArea = document.getElementById('installArea');
const btnInstall = document.getElementById('btnInstall');

window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    installArea.classList.remove('hidden');
});

btnInstall.addEventListener('click', async () => {
    if (deferredPrompt) {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        if (outcome === 'accepted') installArea.classList.add('hidden');
        deferredPrompt = null;
    }
});

window.addEventListener('appinstalled', () => {
    installArea.classList.add('hidden');
});

// Registro de Service Worker
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(err => console.log(err));
    });
}
</script></body></html>
