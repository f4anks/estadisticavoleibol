<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>CV Stats - OFFLINE</title>
    
    <script src="tailwind.js"></script>
    <script src="charts.js"></script>

    <style>
        :root{--b:#0056FF}
        body{font-family:Inter,sans-serif;user-select:none;background:#F7F8FA}
        .card{background:#fff;border:1px solid #d1d5db;box-shadow:0 4px 10px -1px rgba(0,86,255,.1)}
        .toast{position:fixed;bottom:2rem;left:50%;transform:translateX(-50%);background:#1f2937;color:#fff;padding:.75rem 1.5rem;border-radius:.5rem;opacity:0;transition:opacity .3s;pointer-events:none;z-index:999}
        .v{opacity:1}
        input::-webkit-inner-spin-button,input::-webkit-outer-spin-button{-webkit-appearance:none;margin:0}
    </style>
</head>
<body class="p-4 text-gray-800">
    <main class="max-w-5xl mx-auto space-y-6">
        <header class="text-center relative">
            <button onclick="window.close()" class="absolute top-0 right-0 bg-red-600 text-white px-4 py-1 rounded-md text-sm font-bold shadow-md hover:bg-red-700 transition">Salir</button>
            <h1 class="text-3xl font-black">Control Voley <span class="text-yellow-600">Stats</span></h1>
            <p class="text-[10px] text-gray-400">Versión 100% Local (Sin Internet)</p>
        </header>

        <div class="grid gap-6">
            <div class="card p-4 rounded-lg">
                <h2 class="text-xl font-bold mb-3 border-b border-[#0056FF]">Atleta</h2>
                <div class="flex gap-2">
                    <input id="pN" placeholder="Nro" class="w-20 border p-2 rounded" type="number">
                    <input id="pM" placeholder="Nombre" class="flex-grow border p-2 rounded" type="text">
                    <button id="add" class="bg-[#0056FF] text-white px-4 rounded">Agregar</button>
                </div>
            </div>

            <div class="card p-4 rounded-lg">
                <h2 class="text-xl font-bold mb-3 border-b border-[#0056FF]">Acción</h2>
                <form id="f">
                    <select id="ps" class="w-full border p-2 mb-2 rounded"></select>
                    <select id="as" class="w-full border p-2 mb-3 rounded"></select>
                    <button class="w-full bg-[#0056FF] text-white py-2 rounded font-bold mb-2">Registrar</button>
                    <div class="grid grid-cols-2 gap-2">
                        <button type="button" id="rs" class="bg-amber-600 text-white py-1 rounded text-sm">Limpiar Set</button>
                        <button type="button" id="ra" class="bg-red-600 text-white py-1 rounded text-sm">Limpiar Todo</button>
                    </div>
                </form>
            </div>

            <div class="card p-4 rounded-lg">
                <h2 class="text-xl font-bold mb-3 border-b border-[#0056FF]">Estadística</h2>
                <div id="st" class="space-y-2"></div>
            </div>

            <div class="card p-4 rounded-lg h-64"><canvas id="c1"></canvas></div>
            <div class="card p-4 rounded-lg h-80">
                <canvas id="c2"></canvas>
                <div id="sum" class="text-center mt-2 text-xs font-bold"></div>
            </div>
        </div>
    </main>

    <script>
        (function(){
            let L=[], M=[], S=[], b=null, a=null;
            const _=id=>document.getElementById(id),
            N={'Servicio Bueno S#':1,'Ataque Bueno A#':1,'Bloqueo Bueno B#':1,'Coloque Bueno C#':1,'Servicio Malo S=':-1,'Ataque Malo A=':-1,'Bloqueo Malo B=':-1,'Recepción Mala R=':-1,'Coloque Malo C=':-1,'Defensa Mala D=':-1},
            O={S:'Servicio',A:'Ataque',B:'Bloqueo',R:'Recepción',C:'Coloque',D:'Defensa'},
            P={b:'#0056FF',r:'#dc2626',o:'#f97316',g:'#10b981'},
            K={scales:{y:{ticks:{stepSize:1}}},responsive:1,maintainAspectRatio:0};

            function T(m){const t=document.createElement('div');t.className='toast';t.textContent=m;document.body.appendChild(t);setTimeout(()=>t.classList.add('v'),10);setTimeout(()=>{t.classList.remove('v');setTimeout(()=>t.remove(),300)},2000)}
            function G(){localStorage.setItem('vP',JSON.stringify(L));localStorage.setItem('vM',JSON.stringify(M));localStorage.setItem('vS',JSON.stringify(S))}
            
            function U(){
                const s=_('st');s.innerHTML='';if(!L.length){s.innerHTML='<p class="text-center">Vacío</p>';return}
                let d={};L.forEach(p=>d[p.number]={p:0,n:0,a:{}});
                S.forEach(l=>{let k=d[l.playerNumber];if(k){let v=N[l.action],t=l.action.charAt(l.action.length-2);v>0?k.p++:k.n++;if(!k.a[t])k.a[t]={p:0,n:0};v>0?k.a[t].p++:k.a[t].n++}});
                L.forEach(p=>{let k=d[p.number],dt='';Object.keys(k.a).forEach(x=>dt+=`<span class="mr-2">${x}:${k.a[x].p}|${k.a[x].n}</span>`);s.innerHTML+=`<div class="bg-gray-100 p-2 rounded text-xs"><div class="flex justify-between font-bold"><span>#${p.number} ${p.name}</span><span>Dif: ${k.p-k.n}</span></div><div class="text-[9px] text-gray-500">${dt}</div></div>`});
                
                const x1=_('c1').getContext('2d'),x2=_('c2').getContext('2d'),l=Object.values(O);let v1={p:[],n:[]},v2={p:[],n:[]},tp=0,tn=0;
                Object.keys(O).forEach(k=>{let p=0,n=0,ap=0,an=0;S.forEach(z=>{if(z.action.charAt(z.action.length-2)===k)N[z.action]>0?p++:n++});M.forEach(z=>{if(z.action.charAt(z.action.length-2)===k){if(N[z.action]>0){ap++;tp++}else{an++;tn++}}});v1.p.push(p);v1.n.push(n);v2.p.push(ap);v2.n.push(an)});
                
                if(b)b.destroy();b=new Chart(x1,{type:'bar',data:{labels:l,datasets:[{label:'+',data:v1.p,backgroundColor:P.b},{label:'-',data:v1.n,backgroundColor:P.o}]},options:{...K,plugins:{title:{display:1,text:'SET ACTUAL'}}}});
                _('sum').innerHTML=`Pos: ${tp} | Neg: ${tn}`;
                if(a)a.destroy();a=new Chart(x2,{type:'bar',data:{labels:l,datasets:[{label:'+',data:v2.p,backgroundColor:P.g},{label:'-',data:v2.o,backgroundColor:P.o}]},options:{...K,plugins:{title:{display:1,text:'TOTAL PARTIDO'}}}})}

            document.addEventListener('DOMContentLoaded',()=>{
                L=JSON.parse(localStorage.getItem('vP')||'[]');M=JSON.parse(localStorage.getItem('vM')||'[]');S=JSON.parse(localStorage.getItem('vS')||'[]');
                const ps=_('ps'),as=_('as');
                function rP(){ps.innerHTML='';L.sort((a,b)=>a.number-b.number).forEach(p=>{let o=document.createElement('option');o.value=p.number;o.textContent=`#${p.number} ${p.name}`;ps.appendChild(o)})}
                Object.keys(N).forEach(k=>{let o=document.createElement('option');o.value=k;o.textContent=k;as.appendChild(o)});
                _('add').onclick=()=>{let n=parseInt(_('pN').value),m=_('pM').value;if(n&&m){L.push({number:n,name:m});G();rP();U();_('pN').value='';_('pM').value='';T('OK')}};
                _('f').onsubmit=e=>{e.preventDefault();if(ps.value){let l={playerNumber:parseInt(ps.value),action:as.value};M.push(l);S.push(l);G();U();T('Reg')}};
                _('rs').onclick=()=>{if(confirm('¿Limpiar Set?')){S=[];G();U()}};
                _('ra').onclick=()=>{if(confirm('¿Limpiar TODO?')){localStorage.clear();location.reload()}};
                rP();U()
            })
        })()
    </script>
</body>
</html>
